!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=5)}([function(e,t){e.exports=require("express")},function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(12)),s=r(n(2)).default.get("dbInfo");""===s.password&&(console.error("FATAL: yonsei_DBPWD doesn't defined"),process.exit(1)),console.log(s.password);const u=o.default.createConnection(s);u.connect(e=>e?console.error("MySQL connection Error: ",e.sqlMessage):console.log("Connected to MySQL with id: ",u.threadId)),t.default={connection:u,createProgram:function(e){return new Promise((t,n)=>{u.query(`\n    INSERT INTO programs\n    VALUES(\n      DEFAULT,\n      '${e.name}',\n      '${e.description}'\n\t\t);\n    `,(e,r)=>e?n(e):t(r.insertID))})},readPrograms:function(){return new Promise((e,t)=>{u.query("\n    SELECT *\n    FROM programs\n    ",(n,r)=>n?t(n):e(r))})},readProgram:function(e){return new Promise((t,n)=>{u.query(`\n    SELECT *\n    FROM programs\n    WHERE program_id = ${e}\n    `,(e,r)=>e?n(e):t(r[0]))})},updateProgram:function(e,t){return new Promise((n,r)=>{u.query(`\n    UPDATE programs\n\t\tSET name = '${t.name}', description = '${t.description}'\n\t\tWHERE program_id = ${e};\n    `,(e,t)=>e?r(e):n(t[0]))})},deleteProgram:function(e){return new Promise((t,n)=>{u.query(`\n    DELETE FROM programs\n    WHERE program_id = ${e};\n    `,(e,r)=>e?n(e):t(r[0]))})},createUser:function(e){return new Promise((t,n)=>{u.query(`\n\t\tINSERT INTO users\n\t\tVALUES (\n\t\t\tDEFAULT,\n\t\t\t'${e.student_id}',\n\t\t\t'${e.password}',\n\t\t\t'${e.first_name}',\n\t\t\t'${e.last_name}',\n\t\t\t${e.role_id}\n\t\t);\n\t\t`,(r,o)=>r?n(r):0===o.affectedRows?n(new Error("insert doesn't work")):t(Object.assign({user_id:o.insertId},e)))})},readUsers:function(){return new Promise((e,t)=>{u.query("\n    SELECT *\n    FROM users\n    ",(n,r)=>n?t(n):e(r))})},readUser:function(e){return new Promise((t,n)=>{u.query(`\n    SELECT *\n\t\tFROM users\n\t\tWHERE user_id = ${e}\n    `,(e,r)=>e?n(e):t(r[0]))})},readUserByStudentID:function(e){return new Promise((t,n)=>{u.query(`\n    SELECT *\n\t\tFROM users\n\t\tWHERE student_id = ${e}\n    `,(e,r)=>e?n(e):t(r[0]))})}}},function(e,t){e.exports=require("config")},function(e,t){e.exports=require("passport")},function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(15)),s=r(n(2)).default.get("jwtKey");t.default=function(e){const t={sub:e.user_id,iat:Date.now()};return{token:"Bearer "+o.default.sign(t,s,{expiresIn:"1d"}),expires:"1d"}}},function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(6)),s=r(n(7)),u=r(n(2));console.log(u.default.get("name"));const i=process.env.PORT||"3900";s.default.set("port",i);const d=o.default.createServer(s.default);d.listen(i),d.on("error",e=>{console.log("ERROR: ",e)}),d.on("listening",()=>{console.log(`Listening on Port ${i}...`)})},function(e,t){e.exports=require("http")},function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(0)),s=r(n(8)),u=r(n(9)),i=r(n(10)),d=r(n(3));r(n(11)).default(d.default);const a=r(n(14)),c=r(n(16)),l=r(n(17)),f=r(n(20)),p=o.default();p.use(u.default("dev")),p.use(s.default()),p.use(d.default.initialize()),p.use(o.default.json()),p.use(o.default.urlencoded({extended:!0})),p.use("/api/auth",a.default),p.use("/api/users",c.default),p.use("/api/programs",l.default),p.use("/api/enrollments",f.default),p.get("/api/protected",d.default.authenticate("jwt",{session:!1}),(e,t)=>{console.log(e.user),t.send("you are logged in")}),p.use(i.default),t.default=p},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("morgan")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=(e,t,n,r)=>{n.status(500).send("Unexpected Server Error :(")}},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function u(e){try{d(r.next(e))}catch(e){s(e)}}function i(e){try{d(r.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(u,i)}d((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=o(n(1)),u=o(n(2)),i=n(13),d={jwtFromRequest:i.ExtractJwt.fromAuthHeaderAsBearerToken(),secretOrKey:u.default.get("jwtKey")},a=new i.Strategy(d,(e,t)=>r(void 0,void 0,void 0,(function*(){try{const n=yield s.default.readUser(parseInt(e.sub));return t(null,n||!1)}catch(e){return t(e,!1)}})));t.default=e=>e.use(a)},function(e,t){e.exports=require("mysql")},function(e,t){e.exports=require("passport-jwt")},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function u(e){try{d(r.next(e))}catch(e){s(e)}}function i(e){try{d(r.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(u,i)}d((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=n(0),u=o(n(1)),i=o(n(4)),d=s.Router();d.post("/",(e,t)=>r(void 0,void 0,void 0,(function*(){const n=yield u.default.readUserByStudentID(e.body.student_id);if(n||t.status(400).send("Invalid Username or Password"),e.body.password===n.password){const e=i.default(n);t.json({success:!0,user:n,token:e.token,expires:e.expires})}else t.status(400).send("Invalid Username or Password")}))),t.default=d},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function u(e){try{d(r.next(e))}catch(e){s(e)}}function i(e){try{d(r.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(u,i)}d((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=n(0),u=o(n(1)),i=o(n(4)),d=s.Router();d.get("/",(e,t)=>r(void 0,void 0,void 0,(function*(){t.send(yield u.default.readUsers())}))),d.get("/:id",(e,t)=>r(void 0,void 0,void 0,(function*(){const n=yield u.default.readUser(parseInt(e.params.id));n?t.send(n):t.sendStatus(404)}))),d.post("/",(e,t)=>r(void 0,void 0,void 0,(function*(){const n=e.body;if(yield u.default.readUserByStudentID(n.student_id))return t.status(400).json({success:!1,message:"user already exists"});const r=yield u.default.createUser(e.body),o=i.default(r);t.json({success:!0,user:r,token:o.token,expires:o.expires})}))),t.default=d},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function u(e){try{d(r.next(e))}catch(e){s(e)}}function i(e){try{d(r.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(u,i)}d((r=r.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=n(0),u=o(n(1)),i=n(18),d=s.Router();d.get("/",(e,t)=>r(void 0,void 0,void 0,(function*(){const e=yield u.default.readPrograms();t.send(e)}))),d.get("/:id",(e,t)=>r(void 0,void 0,void 0,(function*(){const n=yield u.default.readProgram(parseInt(e.params.id));n?t.send(n):t.sendStatus(404)}))),d.post("/",(e,t)=>r(void 0,void 0,void 0,(function*(){const n=i.validateProgram(e.body);if(n.errors)return t.status(400).send(n.errors);t.send(yield u.default.createProgram(e.body))}))),d.put("/:id",(e,t)=>r(void 0,void 0,void 0,(function*(){const n=i.validateProgram(e.body);if(n.errors)return t.status(400).send(n.errors);t.send(yield u.default.updateProgram(parseInt(e.params.id),e.body))}))),d.delete("/:id",(e,t)=>r(void 0,void 0,void 0,(function*(){yield u.default.deleteProgram(parseInt(e.params.id)),t.sendStatus(204)}))),t.default=d},function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.validateProgram=void 0;const o=r(n(19)),s={name:o.default.string().max(45).required(),description:o.default.string().max(255).required()};t.validateProgram=e=>o.default.object(s).validate(e)},function(e,t){e.exports=require("joi")},function(e,t,n){"use strict";var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(3)),s=n(0),u=r(n(1)),i=s.Router();i.use(o.default.authenticate("jwt",{session:!1})),i.get("/",(e,t)=>{console.log(e.user),u.default.connection.query(1===e.user.role_id?`\n        SELECT *\n\t\t\t\tFROM view_enrollments\n\t\t\t\tWHERE client_id = ${e.user.user_id}\n\t\t`:"\n        SELECT *\n\t\t\t\tFROM view_enrollments\n\t\t",(e,n)=>{if(e)throw new Error("server error");t.json({success:!0,data:n})})}),i.post("/",(e,t)=>{var n;u.default.connection.query(`\n\t\tINSERT INTO enrollments\n\t\tVALUES (\n\t\t\t${null===(n=e.user)||void 0===n?void 0:n.user_id},\n\t\t\t${e.body.program_id},\n\t\t\tNOW(),\n\t\t\t1\n\t\t) \n\t`,(e,n)=>{if(e)throw new Error("server error");t.json({success:!0})})}),i.patch("/",(e,t)=>{u.default.connection.query(`\n\t\tUPDATE enrollments\n\t\tSET status_id = ${e.body.status_id}\n\t\tWHERE program_id=${e.body.program_id} AND client_id=${e.body.client_id}\n\t\t`,(e,n)=>{if(e)throw new Error("server error");t.json({success:!0})})}),i.delete("/:id",(e,t)=>{var n;u.default.connection.query(`\n\t\tDELETE FROM enrollments\n\t\tWHERE program_id=${e.params.id} AND client_id=${null===(n=e.user)||void 0===n?void 0:n.user_id}\n\t\t`,(e,n)=>{if(e)throw new Error("server error");t.json({success:!0})})}),t.default=i}]);
//# sourceMappingURL=index.js.map